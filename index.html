<!doctype html>
<html lang="en">
<head>
<meta http-equiv="content-type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"></meta>
<style type="text/css">
    body {
        margin: 0;
        padding: 1em;
        font-family:ui-monospace,
                    Menlo, Monaco,
                    "Cascadia Mono", "Segoe UI Mono",
                    "Roboto Mono",
                    "Oxygen Mono",
                    "Ubuntu Monospace",
                    "Source Code Pro",
                    "Fira Mono",
                    "Droid Sans Mono",
                    "Courier New", monospace;
        font-size: 12px;
        background: #021617;
    }
    ul {
        list-style: none;
        margin: 0;
        padding: 0;
        display: grid;
        grid-column-gap: 1em;
        grid-row-gap: 1em;
        margin-bottom: 1em;
    }
    ul li {font-size: 1.5em;}
    ul li, ul a {
        background: #d18fda;
        color: #233536;
        padding: 0.5em 1em;
    }
    ul li:nth-child(odd) {
        background: #8fd6da;
    }
    #stats li:last-child {
        display: contents;
    }
    #stats a {
        grid-column-start: 1;
        grid-column-end: 3;
        text-align: center;

    }
    #sort {
        grid-auto-flow: column;
        justify-content: right;
        grid-template-columns: auto;
        font-size:0.8em;
        margin-top:2em;
    }
    #sort li {
        border-top-left-radius:1em;
        border-bottom-right-radius: 1em;
        cursor: pointer;
        user-select: none;
        -webkit-user-select: none;
    }
    #sort li.selected {
        color: #d18fda;
        background: #233536;
    }
    #sort li.selected:after {
        content: "";
        border-width: .6em .3em .6em .3em;
        border-style: solid;
        border-top-width: 0;
        border-color: transparent;
        border-bottom-color: #d18fda;
        display: inline-block;
        margin-left:.6em;
    }
    #sort li.selected.asc:after {
        content: "";
        border-width: .6em .3em .6em .3em;
        border-bottom-width: 0;
        border-top-color: #d18fda;
    }
    #sort li:nth-child(odd).selected {color: #8fd6da;}
    #sort li:nth-child(odd).selected:after {border-bottom-color: #8fd6da;}
    #sort li:nth-child(odd).selected.asc:after {border-top-color: #8fd6da;}
    ul li a, ul li a:visited, ul li a:active {
        color: #8fd6da;
        background: #284443;
        text-decoration: none;
    }
    ul li a:hover {
        color: #d18fda;
    }
    #items {
        display: grid;
        grid-template-columns: 1fr;
        grid-column-gap: 1em;
        grid-row-gap: 1em;
    }
    #items div {
        background: #233536;
        color: #8fd6da;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        box-shadow: 0px 0px 0px #233536;
        transition: all 1s;
        border-bottom-right-radius: 20px;
    }
    #items div.recent {
        background: #233536;
        box-shadow: 0px 0px 10px #f6b1ff;
        transition: all 1s;
        border:2px solid #f6b1ff
    }
    #items div, #items figure {
        border-top-left-radius: 20px;
    }
    #items h2 {
        margin: 0;
        padding: 1em;
        font-size: 1.4em;
    }
    #items p {
        text-align: right;
        margin: 0;
        padding: 0 1em 1em 1em;
        font-size: 1.2em;
        color: #d18fda;
    }
    #items p:nth-child(3) {
        padding-bottom: 0;
        margin: auto 0 0 0;
    }
    #items div figure {
        width: 100%;
        height: 200px;
        background-size: cover;
        background-repeat: no-repeat;
        background-position: center center;
        margin: 0;
        padding: 0;
        cursor: pointer;
    }
    footer {
        margin-top: 2em;
        text-align: center;
        color: #8fd6da;
    }
    footer a, footer a:hover, footer a:visited {color: #d18fda;}
    @media (min-width: 640px) {
        #items {
            grid-template-columns: 1fr 1fr;
        }
        #stats li, #stats a {
            border-top-left-radius:1em;
            border-bottom-right-radius: 1em;
        }
        ul {
            grid-auto-flow: column;
            justify-content: center;
            grid-template-columns: auto;
        }
        #stats a {
            margin-top:0;
            grid-column-start: auto;
            grid-column-end: auto;
        }
    }
    @media (min-width: 1280px) {
        #items {
            grid-template-columns: 1fr 1fr 1fr 1fr;
        }
    }

</style>
</head>
<body>
    <ul id="stats">
        <li id="count"></li>
        <li id="bidders"></li>
        <li id="bids"></li>
        <li id="total"></li>
        <li id="bid"><a href="https://docs.google.com/forms/d/e/1FAIpQLScpclLYzGk4yr6m1HVma7Xs7M34tWFAMJBx1mGEUm9_aFNQIw/viewform">üë®‚Äç‚öñüî®üí∞üè∑Ô∏è  Bid!</a></li>
    </ul>
    <ul id="sort">
        <li sortby="price">Price</li>
        <li sortby="title">Title</li>
        <li sortby="updated" class="selected">Updated</li>
        <li sortby="bidder">Bidder</li>
    </ul>
    <div id="items"></div>
    <footer>
        <p>This is a custom auction front-end focussing on ‚ú® minimalism ‚ú®. It is not intended to be a replacement, nor feature complete, nor to serve any purpose other than my own amusement.</p>
        <p>For the official auction site see <a href="https://www.mkuk.co.uk/hectoring-auction-pt-1">Hectorings Charity Auction at mkuk</a></p>
    </footer>
<script type="text/javascript">
    'use strict';

    const update_frequency = 30 // Seconds
    const recent_cutoff = 24 // Hours
    const base_url = "https://mkuk-auction-develop.up.railway.app" // https://mkuk-hectoring-auction-f8342f11a136.herokuapp.com
    const items_url = `${base_url}/items`
    const bid_count_url = `${base_url}/bid-count`
    const active_bidders_url = `${base_url}/active-bidders`
    const auction_items = document.getElementById("items")
    const sort_options = document.getElementById("sort")

    auction_items.addEventListener("click", (evt) => {
        if (evt.target.tagName === "FIGURE") {
            let url = evt.target.parentElement.getAttribute("image")
            window.open(url)
        }
    })

    sort_options.addEventListener("click", (evt) => {
        let sortby = evt.target.getAttribute("sortby")
        if(!sortby) return;

        let selected = evt.target.classList.contains("selected");

        // Remove selected class from the selected sort option
        (sort_options.querySelector("li.selected") || evt.target).classList.remove("selected")

        // Toggle the sort direction if already selected, otherwise default to ascending
        evt.target.setAttribute("direction", (!selected || evt.target.getAttribute("direction") === "desc") ? "asc" : "desc")

        let direction = evt.target.getAttribute("direction") === "desc";
        evt.target.classList.add("selected")
        evt.target.classList.toggle("asc", direction)
        sort(sortby, direction)
    })

    async function sha256digest(message) {
        const msgUint8 = new TextEncoder().encode(message) // encode as (utf-8) Uint8Array
        const hashBuffer = await window.crypto.subtle.digest("SHA-256", msgUint8) // hash the message
        return Array.from(new Uint8Array(hashBuffer)).map((b) => b.toString(16).padStart(2, "0")).join("") // convert bytes to hex string
    }

    async function update_counts(data) {
        let bid_total = data.reduce((total, item) => total += parseFloat(item.bid), 0.0)
        document.getElementById("total").innerHTML = `<strong>¬£${bid_total}</strong> raised`;
        document.getElementById("count").innerHTML = `<strong>${data.length}</strong> items`;

        fetch(active_bidders_url).then(async (response) => {
            const active_bidders = await response.json()
            document.getElementById("bidders").innerHTML = `<strong>${active_bidders.count}</strong> bidders`;
        })

        fetch(bid_count_url).then(async (response) => {
            const bid_count = await response.json()
            document.getElementById("bids").innerHTML = `<strong>${bid_count.count}</strong> bids`;
        })
    }

    function sort(field, desc = false) {
        let items = Array.from(auction_items.children)
        switch(field) {
            case "price":
                items.sort((a, b) => {
                    let va = parseFloat(a.getAttribute(field))
                    let vb = parseFloat(b.getAttribute(field))
                    return desc ? vb - va : va - vb
                })
                break
            case "title":
                items.sort((a, b) => {
                    let va = a.getElementsByTagName("h2")[0].textContent
                    let vb = b.getElementsByTagName("h2")[0].textContent
                    let diff = va.localeCompare(vb)
                    return desc ? -diff : diff
                })
                break
            case "updated":
                items.sort((a, b) => {
                    let va = parseInt(a.getAttribute("timestamp")) || 0
                    let vb = parseInt(b.getAttribute("timestamp")) || 0
                    return desc ? va - vb : vb - va
                })
                break
            case "bidder":
                items.sort((a, b) => {
                    let va = a.getAttribute("bidder")
                    let vb = b.getAttribute("bidder")
                    let diff = va.localeCompare(vb)
                    return desc ? -diff : diff
                })
                break
        }
        items.forEach((item) => {
            item.remove()
            auction_items.appendChild(item)
        })
    }

    // Lazy load the background images in figures
    const lazyload_observer = new IntersectionObserver((entries) => {
        entries.map((entry) => {
            if (entry.isIntersecting) {
                const figure = entry.target.querySelector("figure")
                const thumbnail = entry.target.getAttribute("image").replace(".jpeg", "l.jpeg")
                figure.style.backgroundImage = `url(${thumbnail})`
                lazyload_observer.unobserve(entry.target)
            }
        })
    });

    async function update(force = false) {
        console.log(`Updating at: ${new Date()}`)
        const response = await fetch(items_url)
        const data = await response.json()

        await update_counts(data)

        await Promise.all(data.map(async (item_data, item_index) => {
            const item_sha = await sha256digest(item_data.desc)
            let item_dom = document.getElementById(item_sha)
            if (!item_dom) {
                item_dom = document.createElement("div")
                item_dom.id = item_sha
                item_dom.innerHTML = `
                    <figure></figure>
                    <h2>${item_data.desc}</h2>
                    <p></p>
                    <p></p>
                `;
                ["Sealed", "Open"].forEach((classifier => {
                    if (item_data.desc.includes(classifier)) {
                        item_dom.setAttribute("type", classifier)
                    }
                }))
                lazyload_observer.observe(item_dom)
                auction_items.appendChild(item_dom)
            }

            const timestamp = new Date(item_data.submitted_at)
            const recent = (new Date().getTime() - timestamp.getTime()) < 1000 * 60 * 60 * recent_cutoff

            item_dom.querySelector("p:nth-child(3)").innerHTML = `<strong>¬£${item_data.bid.replace(".00", "")}</strong> by ${item_data.highest_bidder}`
            item_dom.querySelector("p:nth-child(4)").textContent = timestamp.toLocaleString('en-GB', {dateStyle: 'medium', timeStyle: 'short'})
            item_dom.setAttribute("timestamp", Date.parse(item_data.submitted_at))
            item_dom.setAttribute("price", item_data.bid)
            item_dom.setAttribute("bidder", item_data.highest_bidder)
            item_dom.setAttribute("image", item_data.image)
            item_dom.setAttribute("index", item_index)
            item_dom.classList.toggle("recent", recent)

            return item_dom
        }))

        // Update the sort order
        const current_sort = sort_options.querySelector("li.selected")
        if(current_sort) {
            const sortby = current_sort.getAttribute("sortby")
            const direction = current_sort.getAttribute("direction")
            sort(sortby, direction === "desc")
            console.log(`Sorting by ${sortby}, ${direction}`)
        }
    }

    update()
    const update_interval = setInterval(update, update_frequency * 1000)
</script>
</body>
</html>
